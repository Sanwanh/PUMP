# 抽水機監控系統修改實作指南

## 問題修復與功能增強

本指南提供了針對抽水機監控系統的修改方案，主要解決以下問題：

1. **修正 A100+ ID 無法在 API/JSON 中顯示的問題**
2. **新增自定義顯示順序功能**
3. **新增抽水機顯示選項設定**

## 修改內容概述

### 1. 系統架構

系統架構維持原有的基本架構，但新增了以下內容：

- 新增 `config.json` 檔案，用於存儲使用者設定
- 新增 `settings.html` 頁面，提供設定介面
- 修改 `main.py` 和 `json_api.py`，增加設定功能並修正 A100+ ID 問題

### 2. 檔案架構

```
抽水機監控系統/
├── main.py                # 主要應用程式邏輯
├── json_api.py            # JSON API 處理程式
├── pump_mappings.py       # 抽水機映射資料
├── test_websocket.py      # WebSocket 測試工具
├── config.json            # 使用者設定檔案 (新增)
├── data.xlsx              # 抽水機資料檔案
├── Datalist.xlsx          # 抽水機 ID 列表檔案
├── requirements.txt       # 程式相依套件
├── templates/             # 前端頁面
│   ├── index.html         # 主頁面
│   ├── json_view.html     # JSON 顯示頁面
│   └── settings.html      # 設定頁面 (新增)
└── static/                # 靜態資源
    ├── css/               # CSS 檔案
    ├── js/                # JavaScript 檔案
    └── images/            # 圖片資源
```

## 實作步驟

請依照以下步驟進行修改：

### 步驟 1: 建立設定檔案

在專案根目錄建立 `config.json` 檔案，內容如下：

```json
{
    "display_pumps": [
        "A1", "A5", "A6", "A9", "A10", "A11", "A12", "A13", "A14", "A15", 
        "A17", "A18", "A19", "A20", "A21", "A22", "A23", "A24", "A25", 
        "A33", "A34", "A35", "A36", "A37", "A38", "A39", "A40", "A41", "A42", 
        "A43", "A44", "A45", "A46", "A47", "A48", "A49", "A50", "A51", "A52", 
        "A53", "A54", "A55", "A56", "A57", "A58", "A59", "A60", "A61", "A62", 
        "A63", "A64", "A65", "A66", "A67", "A68", "A69", "A70", "A71", "A72", 
        "A73", "A74", "A75", "A76", "A77", "A78", "A79", "A80", "A81", "A82", 
        "A83", "A84", "A85", "A86", "A87", "A88", "A89", "A90", "A91", "A92", 
        "A93", "A94", "A95", "A96", "A97", "A98", "A101", "A102", "A103", "A104", 
        "A105", "A106", "A107", "A108", "A109", "A110", "A111", "A113", "A114", "A115", 
        "A116", "A117", "A118"
    ],
    "display_order": [
        "A33", "A34", "A35", "A36", "A37", "A38", "A39", "A40", "A41", "A42", 
        "A43", "A44", "A45", "A46", "A1", "A5", "A6", "A9", "A10", "A11", 
        "A12", "A13", "A14", "A15", "A17", "A18", "A19", "A20", "A21", "A22", 
        "A23", "A24", "A25", "A47", "A48", "A49", "A50", "A51", "A52", "A53", 
        "A54", "A55", "A56", "A57", "A58", "A59", "A60", "A61", "A62", "A63", 
        "A64", "A65", "A66", "A67", "A68", "A69", "A70", "A71", "A72", "A73", 
        "A74", "A75", "A76", "A77", "A78", "A79", "A80", "A81", "A82", "A83", 
        "A84", "A85", "A86", "A87", "A88", "A89", "A90", "A91", "A92", "A93", 
        "A94", "A95", "A96", "A97", "A98", "A101", "A102", "A103", "A104", "A105", 
        "A106", "A107", "A108", "A109", "A110", "A111", "A113", "A114", "A115", "A116", 
        "A117", "A118"
    ]
}
```

### 步驟 2: 更新 main.py

以提供的 `fixed-main-py` 中的程式碼替換目前的 `main.py` 檔案內容。主要修改包括：

- 增加讀取和儲存設定檔的函數
- 修改 `convert_to_api_json` 函數，以支援自定義顯示順序
- 新增 `/settings` 和 `/api/save-settings` 路由

### 步驟 3: 建立 settings.html

在 `templates` 資料夾中建立 `settings.html` 檔案，使用提供的 `settings-html` 中的內容。此頁面提供：

- 選擇要顯示的抽水機列表
- 拖曳調整抽水機顯示順序
- 儲存設定功能

### 步驟 4: 更新 json_api.py

以提供的 `updated-json-api-py` 中的程式碼替換目前的 `json_api.py` 檔案內容。主要修改包括：

- 增加設定檔支援
- 修正 A100+ ID 處理問題
- 根據設定排序顯示結果

## 測試方法

修改完成後，請依照以下步驟進行測試：

1. **啟動系統**：
   ```bash
   python main.py
   ```

2. **測試A100+ID顯示**：
   - 訪問 http://localhost:7000/api/json
   - 檢查是否包含 A101 以上的抽水機資料

3. **測試設定功能**：
   - 訪問 http://localhost:7000/settings
   - 嘗試選擇/取消選擇某些抽水機
   - 拖曳調整顯示順序
   - 儲存設定
   - 重新訪問 http://localhost:7000/api/json 檢查更改是否生效

4. **測試上傳功能**：
   - 執行測試工具：`python test_websocket.py`
   - 選擇選項 2 (HTTP GET)
   - 輸入抽水機ID (例如：A108)
   - 檢查是否成功更新資料

## 注意事項

1. **資料保護**：
   - 修改前建議先備份原有 data.xlsx 檔案
   - config.json 檔案包含使用者設定，應予以保護

2. **相容性**：
   - 本修改保留了所有原有功能，僅增加新功能
   - 舊有的 API 端點行為維持不變

3. **效能考量**：
   - 當抽水機數量很多時，設定頁面載入可能較慢
   - 設定搜尋功能可幫助快速找到特定抽水機

## 技術說明

### 主要問題解決方案

1. **A100+ ID問題**：
   - 問題原因：原程式碼在處理ID時可能未正確處理A100以上的ID格式
   - 解決方案：確保ID為字串類型，並正確地處理大數字ID的排序和顯示

2. **資料排序問題**：
   - 問題原因：原程式碼無法自定義資料排序
   - 解決方案：新增config.json設定檔，允許用戶定義顯示順序

3. **設定頁面**：
   - 新增功能：提供直觀的Web介面配置系統行為
   - 技術實現：使用HTML、JavaScript和Sortable.js實現拖曳排序功能

### 未來擴展建議

1. **多用戶支援**：
   - 可增加用戶認證系統，允許不同用戶有各自的設定

2. **更多排序選項**：
   - 可增加按狀態、區域等排序的選項

3. **資料匯出功能**：
   - 可增加資料匯出為CSV、PDF等格式的功能

4. **監控儀表板**：
   - 可開發更直觀的資料視覺化儀表板

## 結論

本修改方案解決了A100+ID無法顯示的問題，並新增了設定頁面使系統更加彈性。通過簡單的步驟即可實現，並保持與原有系統的相容性。